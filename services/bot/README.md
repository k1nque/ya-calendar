# Telegram Bot Service

Микросервис Telegram бота для уведомлений о занятиях и управления учениками.

## Структура файлов

```
services/bot/
├── server.py              # Основной FastAPI сервер
├── bot.py                 # Конфигурация бота и логирования
├── filters.py             # Фильтры для проверки прав администратора
├── handlers/              # Обработчики команд
│   ├── __init__.py
│   ├── admin_handlers.py  # Обработчики для администратора
│   └── user_handlers.py   # Обработчики для пользователей
├── Dockerfile            # Docker конфигурация
└── requirements.txt      # Python зависимости
```

## Компоненты

### server.py
- FastAPI приложение
- Эндпоинт `/notify` для отправки уведомлений
- Эндпоинт `/health` для проверки состояния
- Запуск polling бота при старте приложения

### bot.py
- Создание экземпляров Bot и Dispatcher
- Настройка логирования

### filters.py
- `IsAdmin` - фильтр для проверки администратора в сообщениях
- `IsAdminCallback` - фильтр для проверки администратора в callback-запросах

### handlers/admin_handlers.py
Команды доступные только администратору:
- `/start` - приветствие со справкой
- `/help` - подробная справка
- `/students` - список всех учеников с информацией
- `/inactive` - управление активностью учеников
- `map:` callback - привязка пользователей к ученикам  
- `toggle_active:` callback - переключение активности ученика

### handlers/user_handlers.py
Команды для обычных пользователей:
- `/start` - приветствие и запрос на привязку к ученику

## API Эндпоинты

### POST /notify
Отправка уведомлений о занятии.

**Параметры:**
- `lesson_id` (int) - ID занятия

**Ответ:**
```json
{
  "sent": 2
}
```

### GET /health
Проверка состояния сервиса.

**Ответ:**
```json
{
  "status": "ok"  
}
```

## Команды бота

### Для администратора
- `/start` - показать список команд
- `/help` - справка по всем командам
- `/students` - список учеников с их статусами и количеством оплаченных занятий
- `/inactive` - интерактивное управление активностью учеников

### Для пользователей  
- `/start` - запросить привязку к ученику

## Безопасность

Все административные функции защищены фильтрами, проверяющими ID пользователя против `settings.ADMIN_TELEGRAM_ID`. Обычные пользователи имеют доступ только к команде `/start` для запроса привязки.